<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Popular Gifts — Daily & Weekly Top 10</title>
  <meta name="description" content="Auto‑updated popular gift ideas with filters for age, gender, and category. Pulls from public online sources once per day." />  <!-- Tailwind (production build) -->
  <link rel="stylesheet" href="styles.css" />
  <!-- Build instructions:
    1) npm i -D tailwindcss postcss autoprefixer
    2) npx tailwindcss init -p
    3) tailwind.config.js -> module.exports = { content: ['./index.html'], theme: { extend: {} }, plugins: [] }
    4) Create input.css with:
       @tailwind base;
@tailwind components;
@tailwind utilities;
    5) Build once (or in watch):
       npx tailwindcss -i ./input.css -o ./styles.css --minify
    6) Deploy index.html + styles.css to your static host.
  -->
  <style>
    /* Fallback fonts & small polish */
    html { scroll-behavior: smooth; }
    .truncate-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .truncate-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="sticky top-0 z-20 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center gap-4">
      <div class="flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7 text-rose-600"><path d="M11.645 20.91l-.007-.003-.022-.01a15.247 15.247 0 01-.383-.186 25.18 25.18 0 01-4.244-2.637C4.688 16.357 2.25 13.464 2.25 9.75 2.25 6.988 4.487 4.75 7.25 4.75c1.56 0 3.037.733 3.95 1.904A5.003 5.003 0 0115.25 4.75c2.763 0 5 2.238 5 5 0 3.714-2.438 6.607-4.739 8.324a25.175 25.175 0 01-4.244 2.637 15.247 15.247 0 01-.383.186l-.022.01-.007.003-.003.002a.75.75 0 01-.582 0l-.003-.002z"/></svg>
        <h1 class="text-xl sm:text-2xl font-bold">Popular Gifts — Top 10</h1>
      </div>
      <div class="ml-auto flex items-center gap-2 text-sm text-slate-500">
        <span id="lastUpdated">Last updated: —</span>
        <button id="refreshBtn" class="ml-2 rounded-xl border px-3 py-1.5 hover:bg-slate-100">Refresh now</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Filters -->
    <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 sm:p-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="col-span-1">
          <label class="block text-sm font-medium mb-1">Age</label>
          <select id="ageFilter" class="w-full border rounded-xl px-3 py-2">
            <option value="any">Any</option>
            <option value="toddler">Toddler (1–4)</option>
            <option value="kid">Kids (5–12)</option>
            <option value="teen">Teens (13–17)</option>
            <option value="adult">Adults (18+)</option>
          </select>
        </div>
        <div class="col-span-1">
          <label class="block text-sm font-medium mb-1">Gender</label>
          <select id="genderFilter" class="w-full border rounded-xl px-3 py-2">
            <option value="any">Any</option>
            <option value="female">Female</option>
            <option value="male">Male</option>
            <option value="neutral">Gender‑neutral</option>
          </select>
        </div>
        <div class="col-span-2">
          <label class="block text-sm font-medium mb-1">Categories</label>
          <div class="flex flex-wrap gap-2">
            <label class="inline-flex items-center gap-2 text-sm border rounded-full px-3 py-1.5 cursor-pointer"> <input type="checkbox" class="category" value="overall" checked> Overall </label>
            <label class="inline-flex items-center gap-2 text-sm border rounded-full px-3 py-1.5 cursor-pointer"> <input type="checkbox" class="category" value="toys" checked> Toys </label>
            <label class="inline-flex items-center gap-2 text-sm border rounded-full px-3 py-1.5 cursor-pointer"> <input type="checkbox" class="category" value="electronics" checked> Electronic </label>
            <label class="inline-flex items-center gap-2 text-sm border rounded-full px-3 py-1.5 cursor-pointer"> <input type="checkbox" class="category" value="home" checked> Home & Decor </label>
            <label class="inline-flex items-center gap-2 text-sm border rounded-full px-3 py-1.5 cursor-pointer"> <input type="checkbox" class="category" value="kitchen" checked> Kitchen </label>
          </div>
        </div>
      </div>
      <div class="mt-4 flex flex-wrap items-center gap-3">
        <input id="searchBox" type="search" placeholder="Search titles…" class="border rounded-xl px-3 py-2 w-full md:w-72" />
        <button id="clearFilters" class="rounded-xl border px-3 py-2 hover:bg-slate-100">Clear filters</button>
      </div>
    </section>

    <!-- Today -->
    <section class="mt-6">
      <div class="flex items-baseline justify-between mb-3">
        <h2 class="text-lg sm:text-xl font-semibold">Top 10 Today</h2>
        <a href="#week" class="text-sm text-rose-700 hover:underline">Jump to Week ↓</a>
      </div>
      <div id="todayGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>

    <!-- Week -->
    <section id="week" class="mt-10">
      <div class="flex items-baseline justify-between mb-3">
        <h2 class="text-lg sm:text-xl font-semibold">Top 10 This Week</h2>
        <a href="#" class="text-sm text-rose-700 hover:underline">Back to top ↑</a>
      </div>
      <div id="weekGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>

    <footer class="mt-12 text-center text-sm text-slate-500">
      <p>Sources: curated public lists (Reddit gift & product communities). Updated once per day at midnight.</p>
    </footer>
  </main>

  <template id="cardTpl">
    <article class="group bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden hover:shadow-md transition">
      <a class="block" target="_blank" rel="noopener nofollow">
        <div class="aspect-video bg-slate-100 overflow-hidden">
          <img class="w-full h-full object-cover" alt="Item image" />
        </div>
        <div class="p-4">
          <div class="flex items-center gap-2 text-xs text-slate-500">
            <span class="subreddit"></span>
            <span>•</span>
            <span class="score"></span>
            <span class="ml-auto px-2 py-0.5 rounded-full bg-rose-50 text-rose-700 categoryTag"></span>
          </div>
          <h3 class="mt-2 font-semibold leading-snug truncate-2 title"></h3>
          <p class="mt-1 text-sm text-slate-600 truncate-3 desc"></p>
        </div>
      </a>
      <div class="flex gap-2 p-3 border-t text-xs text-slate-500">
        <a class="redditLink hover:underline" target="_blank" rel="noopener">Reddit</a>
        <span>•</span>
        <a class="outLink hover:underline" target="_blank" rel="noopener nofollow">Product / Link</a>
      </div>
    </article>
  </template>

  <script>
    // =============== CONFIG ===============
    const SUBREDDITS = [
      // Overall & gift-focused
      { name: 'GiftIdeas', weight: 1.2, cat: 'overall' },
      { name: 'BuyItForLife', weight: 1.0, cat: 'overall' },
      // Category focused
      { name: 'toys', weight: 1.1, cat: 'toys' },
      { name: 'boardgames', weight: 1.1, cat: 'toys' },
      { name: 'coolgadgets', weight: 1.1, cat: 'electronics' },
      { name: 'gadgets', weight: 1.0, cat: 'electronics' },
      { name: 'HomeDecorating', weight: 1.0, cat: 'home' },
      { name: 'Malelivingspace', weight: 0.9, cat: 'home' },
      { name: 'KitchenGadgets', weight: 1.1, cat: 'kitchen' },
      { name: 'BuyItForLife', weight: 1.0, cat: 'home' },
    ];

    const LIMIT_PER_SOURCE = 25; // grab more than we need, then filter to top 10
    const MAX_ITEMS = 10;

    // Simple keyword rules for tagging age/gender quickly (heuristic)
    const RULES = {
      age: [
        { id: 'toddler', re: /(toddler|preschool|ages?\s?(1|2|3|4)\b|age\s?\d-?\d\b|1-4\b)/i },
        { id: 'kid', re: /(kids?|child|children|ages?\s?(5|6|7|8|9|10|11|12)\b|5-12\b)/i },
        { id: 'teen', re: /(teen|teens|tween|13-17\b|ages?\s?(13|14|15|16|17)\b)/i },
        { id: 'adult', re: /(adult|grown|for him|for her|men|women|dad|mom|boyfriend|girlfriend)/i },
      ],
      gender: [
        { id: 'female', re: /(for her|women|woman|girl|mom|girlfriend|wife)/i },
        { id: 'male', re: /(for him|men|man|boy|dad|boyfriend|husband)/i },
      ]
    };

    // =============== UTILITIES ===============
    const byId = (id) => document.getElementById(id);
    const fmtK = (n) => n >= 1000 ? (n/1000).toFixed(1) + 'k' : String(n);

    function pickImage(post) {
      // Prefer preview images; fallback to subreddit icon or generic
      try {
        const p = post.preview?.images?.[0]?.source?.url || post.thumbnail;
        if (p && p !== 'self' && p !== 'default' && p !== 'nsfw' && p.startsWith('http')) return p.replace(/&amp;/g, '&');
      } catch {}
      return 'https://images.unsplash.com/photo-1549465220-1a8b9238cd48?auto=format&fit=crop&w=1200&q=60';
    }

    function extractExternal(post) {
      // If the post directly links out (not a self post), use that
      const url = post.url_overridden_by_dest || post.url;
      const isRedditLink = /reddit\.com\//i.test(url);
      return isRedditLink ? null : url;
    }

    function classify(text, fallbackCat) {
      const t = text || '';
      const age = RULES.age.find(r => r.re.test(t))?.id || 'any';
      const gender = RULES.gender.find(r => r.re.test(t))?.id || 'neutral';
      return { age, gender, cat: fallbackCat };
    }

    function scorePost(p, weight = 1) {
      // Combine score + comments with a small boost from subreddit weight
      const ups = p.ups || p.score || 0;
      const com = p.num_comments || 0;
      return Math.round((ups * 1.0 + com * 3) * weight);
    }

    // =============== FETCHING ===============
    async function fetchTop(sub, period = 'day') {
      const url = `https://www.reddit.com/r/${sub}/top.json?t=${period}&limit=${LIMIT_PER_SOURCE}`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error(`HTTP ${res.status} for r/${sub}`);
      const json = await res.json();
      return json.data.children.map(c => c.data);
    }

    async function gather(period) {
      const tasks = SUBREDDITS.map(async ({ name, weight, cat }) => {
        try {
          const posts = await fetchTop(name, period);
          return posts.map(p => ({ post: p, sub: name, weight, cat }));
        } catch (err) {
          console.warn('Failed', name, err.message);
          return [];
        }
      });
      const nested = await Promise.all(tasks);
      return nested.flat();
    }

    function normalize(items) {
      const seen = new Set();
      const result = [];
      for (const { post, sub, weight, cat } of items) {
        if (post.over_18) continue; // skip nsfw
        const key = post.id;
        if (seen.has(key)) continue;
        seen.add(key);
        const external = extractExternal(post);
        const img = pickImage(post);
        const { age, gender } = classify(`${post.title} ${post.selftext || ''}`, cat);
        const sc = scorePost(post, weight);
        result.push({
          id: key,
          title: post.title,
          desc: (post.selftext || '').slice(0, 280),
          subreddit: sub,
          score: sc,
          redditUrl: `https://www.reddit.com${post.permalink}`,
          outUrl: external || `https://www.reddit.com${post.permalink}`,
          image: img,
          cat,
          age,
          gender
        });
      }
      // sort by score desc
      result.sort((a,b) => b.score - a.score);
      return result;
    }

    // =============== RENDER ===============
    function renderCards(targetEl, items) {
      targetEl.innerHTML = '';
      const tpl = byId('cardTpl');
      items.slice(0, MAX_ITEMS).forEach(it => {
        const node = tpl.content.cloneNode(true);
        const a = node.querySelector('a.block');
        const img = node.querySelector('img');
        const title = node.querySelector('.title');
        const desc = node.querySelector('.desc');
        const score = node.querySelector('.score');
        const sub = node.querySelector('.subreddit');
        const cat = node.querySelector('.categoryTag');
        const redditLink = node.querySelector('.redditLink');
        const outLink = node.querySelector('.outLink');

        a.href = it.outUrl;
        img.src = it.image;
        img.alt = it.title;
        title.textContent = it.title;
        desc.textContent = it.desc;
        score.textContent = `${fmtK(it.score)} pts`;
        sub.textContent = `r/${it.subreddit}`;
        cat.textContent = labelForCategory(it.cat);
        redditLink.href = it.redditUrl;
        outLink.href = it.outUrl;

        targetEl.appendChild(node);
      });
    }

    function labelForCategory(cat) {
      switch (cat) {
        case 'toys': return 'Toys';
        case 'electronics': return 'Electronics';
        case 'home': return 'Home & Decor';
        case 'kitchen': return 'Kitchen';
        default: return 'Overall';
      }
    }

    function showSkeleton(el) {
      el.innerHTML = '';
      for (let i=0;i<6;i++) {
        const div = document.createElement('div');
        div.className = 'animate-pulse bg-white rounded-2xl border border-slate-200 h-48';
        el.appendChild(div);
      }
    }

    // =============== FILTERS ===============
    function applyFilters(fullList) {
      const selectedCats = Array.from(document.querySelectorAll('input.category:checked')).map(i => i.value);
      const age = byId('ageFilter').value;
      const gender = byId('genderFilter').value;
      const q = byId('searchBox').value.trim().toLowerCase();

      return fullList.filter(it => {
        const matchCat = selectedCats.includes(it.cat);
        const matchAge = age === 'any' ? true : it.age === age;
        const matchGender = gender === 'any' ? true : (gender === 'neutral' ? it.gender === 'neutral' : it.gender === gender);
        const matchQ = q ? (it.title.toLowerCase().includes(q) || (it.desc||'').toLowerCase().includes(q)) : true;
        return matchCat && matchAge && matchGender && matchQ;
      });
    }

    // =============== CACHE & REFRESH ===============
    const storage = {
      set(key, value) { localStorage.setItem(key, JSON.stringify({ at: Date.now(), value })); },
      get(key) { try { const x = JSON.parse(localStorage.getItem(key)); return x?.value ?? null; } catch { return null; } },
      getTime(key) { try { const x = JSON.parse(localStorage.getItem(key)); return x?.at ?? 0; } catch { return 0; } }
    };

    function midnightOf(d = new Date()) {
      const x = new Date(d);
      x.setHours(0,0,0,0); return x.getTime();
    }

    function msUntilNextMidnight() {
      const now = new Date();
      const next = new Date(now);
      next.setHours(24,0,0,0); // next day 00:00 local
      return next - now;
    }

    function setLastUpdated(ts) {
      const dt = new Date(ts);
      byId('lastUpdated').textContent = `Last updated: ${dt.toLocaleString()}`;
    }

    // =============== MAIN ===============
    let state = { today: [], week: [], todayRaw: [], weekRaw: [] };

    async function load(period) {
      const key = period === 'day' ? 'gift_today' : 'gift_week';
      const lastKey = key + '_time';
      const lastAt = storage.getTime(lastKey);
      const isStale = (period === 'day') ? (midnightOf(new Date()) > midnightOf(new Date(lastAt))) : (Date.now() - lastAt > 1000*60*60*6); // refresh weekly list every 6h

      if (!isStale) {
        const cached = storage.get(key);
        if (cached) {
          if (period === 'day') state.today = cached; else state.week = cached;
          setLastUpdated(lastAt);
          return;
        }
      }

      const aggregated = await gather(period);
      const normalized = normalize(aggregated);
      storage.set(key, normalized);
      storage.set(lastKey, Date.now());
      setLastUpdated(Date.now());
      if (period === 'day') state.today = normalized; else state.week = normalized;
    }

    function refreshUI() {
      const tItems = applyFilters(state.today);
      const wItems = applyFilters(state.week);
      renderCards(byId('todayGrid'), tItems.slice(0, MAX_ITEMS));
      renderCards(byId('weekGrid'), wItems.slice(0, MAX_ITEMS));
    }

    async function boot() {
      showSkeleton(byId('todayGrid'));
      showSkeleton(byId('weekGrid'));
      await Promise.all([load('day'), load('week')]);
      refreshUI();

      // schedule midnight refresh
      setTimeout(async () => {
        await load('day');
        await load('week');
        refreshUI();
        // re-arm timer
        setInterval(async () => { await load('day'); await load('week'); refreshUI(); }, 24*60*60*1000);
      }, msUntilNextMidnight());
    }

    // =============== EVENTS ===============
    ['ageFilter','genderFilter'].forEach(id => byId(id).addEventListener('change', refreshUI));
    document.querySelectorAll('input.category').forEach(cb => cb.addEventListener('change', refreshUI));
    byId('searchBox').addEventListener('input', () => { refreshUI(); });

    byId('clearFilters').addEventListener('click', () => {
      byId('ageFilter').value = 'any';
      byId('genderFilter').value = 'any';
      document.querySelectorAll('input.category').forEach(cb => cb.checked = true);
      byId('searchBox').value = '';
      refreshUI();
    });

    byId('refreshBtn').addEventListener('click', async () => {
      showSkeleton(byId('todayGrid'));
      showSkeleton(byId('weekGrid'));
      // force refetch now
      storage.set('gift_today_time', midnightOf(new Date(2000,0,1))); // ancient time -> stale
      storage.set('gift_week_time', midnightOf(new Date(2000,0,1)));
      await Promise.all([load('day'), load('week')]);
      refreshUI();
    });

    // Start!
    boot().catch(err => {
      console.error(err);
      byId('todayGrid').innerHTML = `<div class="p-6 bg-white rounded-2xl border text-sm text-red-700">Failed to load today list. ${err.message}</div>`;
      byId('weekGrid').innerHTML = `<div class="p-6 bg-white rounded-2xl border text-sm text-red-700">Failed to load weekly list. ${err.message}</div>`;
    });
  </script>
</body>
</html>
