<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trending Gift Ideas — Daily & Weekly (No Backend)</title>
  <meta name="description" content="Top 10 gift ideas for today and this week. Filters for age, gender, and category. Auto-refreshes at midnight. No backend required." />
  <!-- Tailwind (CDN) for quick styling; swap to your own build if desired -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .shadow-soft { box-shadow: 0 10px 30px rgba(0,0,0,.06); }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <main class="max-w-6xl mx-auto px-4 py-8">
    <header class="mb-6">
      <h1 class="text-3xl font-bold">Trending Gift Ideas</h1>
      <p class="text-slate-600">Pulls from public sources (e.g., Reddit gift subreddits). Top 10 for today & this week. Auto-refreshes at local midnight.</p>
      <p class="text-xs text-slate-500 mt-1">Tip: Update the Amazon affiliate tag in the code (<code>YOUR_TAG_20</code>) to earn commissions.</p>
    </header>

    <!-- Controls -->
    <section class="bg-white rounded-2xl shadow-soft p-4 md:p-6 mb-6">
      <div class="flex flex-col md:flex-row gap-4 md:items-end md:justify-between">
        <div class="grid grid-cols-2 md:grid-cols-5 gap-3 w-full">
          <div>
            <label class="text-sm text-slate-500">Period</label>
            <select id="period" class="mt-1 w-full border rounded-lg px-3 py-2">
              <option value="day">Today</option>
              <option value="week">This Week</option>
            </select>
          </div>
          <div>
            <label class="text-sm text-slate-500">Category</label>
            <select id="category" class="mt-1 w-full border rounded-lg px-3 py-2">
              <option value="overall">Overall</option>
              <option value="toys">Toys</option>
              <option value="electronics">Electronics</option>
              <option value="home_decor">Home & Decor</option>
              <option value="kitchen">Kitchen</option>
            </select>
          </div>
          <div>
            <label class="text-sm text-slate-500">Gender</label>
            <select id="gender" class="mt-1 w-full border rounded-lg px-3 py-2">
              <option value="all">All</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="nonbinary">Non-binary</option>
            </select>
          </div>
          <div>
            <label class="text-sm text-slate-500">Min Age</label>
            <input id="ageMin" type="number" min="0" max="99" value="0" class="mt-1 w-full border rounded-lg px-3 py-2" />
          </div>
          <div>
            <label class="text-sm text-slate-500">Max Age</label>
            <input id="ageMax" type="number" min="0" max="99" value="99" class="mt-1 w-full border rounded-lg px-3 py-2" />
          </div>
        </div>
        <div class="flex gap-3">
          <input id="q" placeholder="Search titles…" class="border rounded-lg px-3 py-2 w-56" />
          <button id="refresh" type="button" class="px-4 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800 cursor-pointer select-none">Refresh now</button>
        </div>
      </div>
      <div class="text-xs text-slate-500 mt-3" id="meta"></div>
      <div class="mt-3 text-xs text-amber-700" id="diag"></div>
      <div class="mt-3 flex gap-2">
        <button id="sample" class="px-3 py-2 rounded-lg border">Load sample data</button>
        <button id="toggleProxy" class="px-3 py-2 rounded-lg border">Toggle proxy (on)</button>
      </div>
    </section>

    <!-- Results -->
    <section class="space-y-6">
      <h2 class="text-xl font-semibold" id="sectionTitle">Top 10 Today</h2>
      <div id="grid" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5"></div>
      <p id="error" class="text-sm text-rose-600"></p>
    </section>

    <footer class="mt-12 text-sm text-slate-500">
      <p>Sources: Reddit (e.g., r/GiftIdeas, r/BuyItForLife). Titles are linked to Amazon searches with your affiliate tag. Replace <code>YOUR_TAG_20</code> in the script.</p>
    </footer>
  </main>

  <script>
  // Ensure code runs after DOM is ready even if script is moved
  document.addEventListener('DOMContentLoaded', () => {
    // ---------------------------
    // Config
    // ---------------------------
    const AMAZON_TAG = 'YOUR_TAG_20'; // <-- change this

    // Force proxy can help on GitHub Pages or file:// where CORS blocks direct calls
    let USE_PROXY_ALWAYS = true;

    const SUBREDDITS = {
      overall: ['GiftIdeas', 'BuyItForLife', 'WhichGift'],
      toys: ['toys', 'GiftIdeas', 'boardgames', 'lego'],
      electronics: ['buildapcsales', 'headphones', 'GiftIdeas', 'BuyItForLife'],
      home_decor: ['HomeDecorating', 'GiftIdeas', 'BuyItForLife'],
      kitchen: ['Cooking', 'GiftIdeas', 'BuyItForLife']
    };

    const GENDER_KEYWORDS = {
      male: [/\bfor\s?him\b/i, /\bmen\b/i, /\bboy(s)?\b/i],
      female: [/\bfor\s?her\b/i, /\bwomen\b/i, /\bgirl(s)?\b/i],
      nonbinary: [/\bunisex\b/i, /\bgender[-\s]?neutral\b/i]
    };

    const AGE_KEYWORDS = [
      {min:0, max:12, re:/(kid|child|children|toddler|age\s*\d-?\d?|ages?\s*3|4|5|6|7|8|9|10|11|12)/i},
      {min:13, max:17, re:/(teen|teenager|high\s*school|middle\s*school)/i},
      {min:18, max:99, re:/(adult|for\s*adults)/i}
    ];

    // ---------------------------
    // Helpers
    // ---------------------------
    function amazonSearchLink(title){
      const q = encodeURIComponent(title.replace(/\[.*?\]/g,'').replace(/\(.*?\)/g,''));
      const url = `https://www.amazon.com/s?k=${q}&tag=${AMAZON_TAG}`;
      return url;
    }

    function pickImage(post){
      if(post.thumbnail && post.thumbnail.startsWith('http')) return post.thumbnail;
      if(post.preview && post.preview.images && post.preview.images[0]){
        const src = post.preview.images[0].source.url.replace(/&amp;/g,'&');
        return src;
      }
      return 'https://picsum.photos/seed/gifts/400/300';
    }

    function matchesGender(title, wanted){
      if(wanted==='all') return true;
      const arr = GENDER_KEYWORDS[wanted] || [];
      return arr.some(re => re.test(title));
    }

    function matchesAge(title, min, max){
      // Heuristic: allow if no age signal OR if a detected band overlaps asked range
      const found = AGE_KEYWORDS.find(k => k.re.test(title));
      if(!found) return true;
      return !(found.max < min || found.min > max);
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function fmtDate(d){ return new Date(d).toLocaleString(); }

    function nextLocalMidnight(){
      const now = new Date();
      const next = new Date(now);
      next.setHours(24,0,0,0);
      return next.getTime() - now.getTime();
    }

    // ---------------------------
    // Fetchers
    // ---------------------------
    async function fetchSubredditTop(sub, period){
      const base = `https://www.reddit.com/r/${sub}/top.json?raw_json=1&t=${period}&limit=50&_=${Date.now()}`;
      const proxied1 = `https://cors.isomorphic-git.org/${base}`;
      const proxied2 = `https://r.jina.ai/http://www.reddit.com/r/${sub}/top.json?raw_json=1&t=${period}&limit=50&_=${Date.now()}`;
      const proxied3 = `https://r.jina.ai/http://api.reddit.com/r/${sub}/top.json?raw_json=1&t=${period}&limit=50&_=${Date.now()}`;

      async function tryJson(u){
        const res = await fetch(u, { credentials: 'omit' });
        if(!res.ok) throw new Error(`HTTP ${res.status} @ ${u.split('/r/')[0]}`);
        const json = await res.json();
        const posts = (json?.data?.children || []).map(x => x.data);
        if(!Array.isArray(posts) || posts.length === 0) throw new Error('Empty list');
        return posts;
      }

      async function tryTextJson(u){
        const res = await fetch(u, { credentials: 'omit' });
        if(!res.ok) throw new Error(`HTTP ${res.status} @ ${u.split('/r/')[0]}`);
        const txt = await res.text();
        const json = JSON.parse(txt);
        const posts = (json?.data?.children || []).map(x => x.data);
        if(!Array.isArray(posts) || posts.length === 0) throw new Error('Empty list');
        return posts;
      }

      const chain = USE_PROXY_ALWAYS ? [proxied1, proxied2, proxied3, base] : [base, proxied1, proxied2, proxied3];
      let lastErr;
      for(const u of chain){
        try {
          const usingText = u.startsWith('https://r.jina.ai/');
          const result = usingText ? await tryTextJson(u) : await tryJson(u);
          logDiag(`Loaded ${sub} via ${usingText ? 'jina.ai' : (u.includes('isomorphic-git')?'isomorphic proxy':'direct reddit')}`);
          return result;
        } catch(e){ lastErr = e; logDiag(`Fetch failed for ${sub}: ${e.message}`); }
      }
      throw lastErr || new Error('All sources failed');
    }/top.json?raw_json=1&t=${period}&limit=50`;
      const proxied1 = `https://cors.isomorphic-git.org/${base}`;
      // r.jina.ai returns raw response with permissive CORS; parse as text then JSON
      const proxied2 = `https://r.jina.ai/http://www.reddit.com/r/${sub}/top.json?raw_json=1&t=${period}&limit=50`;

      async function tryJson(u){
        const res = await fetch(u, { credentials: 'omit' });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        const posts = (json?.data?.children || []).map(x => x.data);
        if(!Array.isArray(posts) || posts.length === 0) throw new Error('Empty list');
        return posts;
      }

      async function tryTextJson(u){
        const res = await fetch(u, { credentials: 'omit' });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const txt = await res.text();
        const json = JSON.parse(txt);
        const posts = (json?.data?.children || []).map(x => x.data);
        if(!Array.isArray(posts) || posts.length === 0) throw new Error('Empty list');
        return posts;
      }

      const chain = USE_PROXY_ALWAYS ? [proxied1, proxied2, base] : [base, proxied1, proxied2];
      let lastErr;
      for(const u of chain){
        try {
          if(u === proxied2) return await tryTextJson(u);
          return await tryJson(u);
        } catch(e){ lastErr = e; }
      }
      throw lastErr || new Error('All sources failed');
    }/top.json?raw_json=1&t=${period}&limit=50`;
      const proxied = `https://cors.isomorphic-git.org/${base}`;

      async function tryUrl(u){
        const res = await fetch(u, { credentials: 'omit' });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        const posts = (json?.data?.children || []).map(x => x.data);
        if(!Array.isArray(posts) || posts.length === 0) throw new Error('Empty list');
        return posts;
      }

      try {
        return await tryUrl(base);
      } catch (e1){
        console.warn('Direct Reddit fetch failed; retrying via proxy', e1);
        try {
          return await tryUrl(proxied);
        } catch(e2){
          console.warn('Proxy fetch failed', e2);
          throw e2;
        }
      }
    }/top.json?t=${period}&limit=50`;
      const res = await fetch(url, { cache: 'no-store' });
      if(!res.ok) throw new Error(`Reddit ${sub} ${res.status}`);
      const json = await res.json();
      const posts = (json.data.children || []).map(x => x.data);
      return posts;
    }

    async function load(period, category){
      const subs = SUBREDDITS[category] || SUBREDDITS.overall;
      const all = [];
      for(const s of subs){
        try {
          const posts = await fetchSubredditTop(s, period);
          all.push(...posts);
        } catch(e){
          console.warn('Fetch failed for', s, e);
        }
      }
      // Deduplicate by title, prefer higher score
      const byTitle = new Map();
      for(const p of all){
        const title = p.title.trim();
        const cur = byTitle.get(title);
        if(!cur || p.score > cur.score) byTitle.set(title, p);
      }
      return Array.from(byTitle.values()).sort((a,b)=>b.score-a.score);
    }

    // ---------------------------
    // Render
    // ---------------------------
    function render(items){
      logDiag(`Rendering ${items.length} item(s)`);
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      items.forEach((p, idx) => {
        const card = document.createElement('article');
        card.className = 'bg-white rounded-2xl shadow-soft overflow-hidden flex flex-col';
        const img = pickImage(p);
        const a = amazonSearchLink(p.title || 'Gift idea');
        card.innerHTML = `
          <div class="relative aspect-[4/3] bg-slate-100">
            <img src="${img}" alt="${(p.title||'Gift idea').replace(/\"/g,'&quot;')}" class="w-full h-full object-cover" loading="lazy" />
            <span class="absolute top-2 left-2 text-xs px-2 py-1 rounded-lg bg-black/70 text-white">#${idx+1}</span>
          </div>
          <div class="p-4 flex-1 flex flex-col gap-2">
            <div class="text-xs text-slate-500">Reddit · score ${p.score ?? '—'}</div>
            <h3 class="font-semibold leading-snug line-clamp-2">${(p.title||'Gift idea').replace(/</g,'&lt;')}</h3>
            <div class="mt-auto">
              <a href="${a}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 text-indigo-700 hover:underline">
                <span>View on Amazon</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6 2a1 1 0 0 0 0 2h3.586L2.293 11.293a1 1 0 1 0 1.414 1.414L11 5.414V9a1 1 0 1 0 2 0V3a1 1 0 0 0-1-1H6z"/></svg>
              </a>
            </div>
          </div>`;
        grid.appendChild(card);
      });
    }" alt="${p.title.replace(/\"/g,'&quot;')}" class="w-full h-full object-cover" loading="lazy" />
            <span class="absolute top-2 left-2 text-xs px-2 py-1 rounded-lg bg-black/70 text-white">#${idx+1}</span>
          </div>
          <div class="p-4 flex-1 flex flex-col gap-2">
            <div class="text-xs text-slate-500">Reddit · score ${p.score}</div>
            <h3 class="font-semibold leading-snug line-clamp-2">${p.title.replace(/</g,'&lt;')}</h3>
            <div class="mt-auto">
              <a href="${a}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 text-indigo-700 hover:underline">
                <span>View on Amazon</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6 2a1 1 0 0 0 0 2h3.586L2.293 11.293a1 1 0 1 0 1.414 1.414L11 5.414V9a1 1 0 1 0 2 0V3a1 1 0 0 0-1-1H6z"/></svg>
              </a>
            </div>
          </div>`;
        grid.appendChild(card);
      });
    }

    // ---------------------------
    // State + Filtering
    // ---------------------------
    const els = {
      period: document.getElementById('period'),
      category: document.getElementById('category'),
      gender: document.getElementById('gender'),
      ageMin: document.getElementById('ageMin'),
      ageMax: document.getElementById('ageMax'),
      q: document.getElementById('q'),
      refresh: document.getElementById('refresh'),
      meta: document.getElementById('meta'),
      title: document.getElementById('sectionTitle'),
      error: document.getElementById('error'),
      diag: document.getElementById('diag'),
      sample: document.getElementById('sample'),
      toggleProxy: document.getElementById('toggleProxy')
    };

    let cache = { day: {}, week: {} }; // cache[period][category] = posts

    function applyFilters(posts){
      const q = els.q.value.trim().toLowerCase();
      const gender = els.gender.value;
      const ageMin = parseInt(els.ageMin.value, 10) || 0;
      const ageMax = parseInt(els.ageMax.value, 10) || 99;

      let list = posts.filter(p => !p.stickied);

      if(gender !== 'all'){
        list = list.filter(p => matchesGender(p.title, gender));
      }

      list = list.filter(p => matchesAge(p.title, ageMin, ageMax));

      if(q){
        list = list.filter(p => p.title.toLowerCase().includes(q));
      }

      return list.slice(0, 10);
    }

    function logDiag(msg){
      try{ els.diag.textContent = msg + (els.diag.textContent ? ('
' + els.diag.textContent) : ''); }catch(_){ /* noop */ }
    }

    async function refreshData(force=false){
      const period = els.period.value; // day|week
      const category = els.category.value; // key
      els.error.textContent = '';

      try {
        if(!cache[period][category] || force){
          const posts = await load(period, category);
          cache[period][category] = posts;
        }
        const filtered = applyFilters(cache[period][category]);
        if(filtered.length === 0){
          els.error.textContent = 'No posts matched your filters just now. Try widening the age/gender or switch category.';
        }
        render(filtered);
        const meta = `Period: ${period === 'day' ? 'Today' : 'This Week'} · Category: ${category.replace('_',' ')} · Updated ${fmtDate(Date.now())}`;
        els.meta.textContent = meta;
        els.title.textContent = period === 'day' ? 'Top 10 Today' : 'Top 10 This Week';
      } catch(e){
        console.error(e);
        els.error.textContent = 'Could not load sources right now. Your browser, ad-blocker, or CORS policy may be blocking Reddit. Retrying via proxy…';
        // Force one more attempt via proxies
        try {
          cache[period][category] = await (async ()=>{
            const subs = SUBREDDITS[category] || SUBREDDITS.overall;
            const all = [];
            for(const s of subs){
              try { all.push(...await fetchSubredditTop(s, period)); } catch(_){}
            }
            return all;
          })();
          const filtered = applyFilters(cache[period][category]);
          render(filtered.slice(0,10));
          if(filtered.length === 0){ els.error.textContent = 'Still no results after retry. Try disabling ad blockers for this page or switching category.'; }
        } catch(e2){
          els.error.textContent = 'All attempts failed. As a fallback, here are a few evergreen ideas:';
          render([ { title: 'Insulated Tumbler' }, { title: 'LED String Lights' }, { title: 'Cozy Throw Blanket' }, { title: 'Bluetooth Beanie' } ]);
        }
      }
    }
        const filtered = applyFilters(cache[period][category]);
        render(filtered);
        const meta = `Period: ${period === 'day' ? 'Today' : 'This Week'} · Category: ${category.replace('_',' ')} · Updated ${fmtDate(Date.now())}`;
        els.meta.textContent = meta;
        els.title.textContent = period === 'day' ? 'Top 10 Today' : 'Top 10 This Week';
      } catch(e){
        console.error(e);
        els.error.textContent = 'Could not load sources right now. Showing a short fallback list.';
        render([ { title: 'Insulated Tumbler', score: 1 }, { title: 'LED String Lights', score: 1 }, { title: 'Cozy Throw Blanket', score: 1 } ].map((t,i)=>({ title: t.title, score: 1, thumbnail:'', preview:null })));
      }
    }

    // Auto-refresh at next local midnight
    setTimeout(() => refreshData(true), nextLocalMidnight());

    // Restore URL params
    (function restoreFromQuery(){
      const u = new URL(location.href);
      const get = (k, d) => u.searchParams.get(k) || d;
      els.period.value = get('period','day');
      els.category.value = get('category','overall');
      els.gender.value = get('gender','all');
      els.ageMin.value = clamp(parseInt(get('ageMin','0'),10)||0, 0, 99);
      els.ageMax.value = clamp(parseInt(get('ageMax','99'),10)||99, 0, 99);
      els.q.value = get('q','');
    })();

    // Persist URL params
    function syncQuery(){
      const u = new URL(location.href);
      u.searchParams.set('period', els.period.value);
      u.searchParams.set('category', els.category.value);
      u.searchParams.set('gender', els.gender.value);
      u.searchParams.set('ageMin', els.ageMin.value);
      u.searchParams.set('ageMax', els.ageMax.value);
      if(els.q.value) u.searchParams.set('q', els.q.value); else u.searchParams.delete('q');
      history.replaceState(null, '', u.toString());
    }

    // Wire events
    ['change','keyup'].forEach(evt => {
      els.q.addEventListener(evt, () => { syncQuery(); refreshData(); });
    });
    [els.period, els.category, els.gender, els.ageMin, els.ageMax].forEach(el => {
      el.addEventListener('change', () => { syncQuery(); refreshData(); });
      el.addEventListener('keyup', () => { syncQuery(); refreshData(); });
    });
    els.refresh.addEventListener('click', () => refreshData(true));
    els.sample.addEventListener('click', () => {
      const demo = [
        { title: 'Cozy Sherpa Throw Blanket', score: 421 },
        { title: 'Insulated Stainless Steel Tumbler 40oz', score: 382 },
        { title: 'LED String Lights (USB)', score: 271 },
        { title: 'Wireless Earbuds Bluetooth 5.3', score: 215 },
        { title: 'Scented Candle Gift Set', score: 188 },
        { title: 'Mini Projector for Movies', score: 172 },
        { title: 'Massage Gun Handheld', score: 166 },
        { title: 'Lego Flowers Bouquet', score: 141 },
        { title: 'Board Game – Ticket to Ride', score: 119 },
        { title: 'Electric Milk Frother', score: 101 }
      ];
      render(demo);
      els.error.textContent = '';
      els.meta.textContent = 'Sample data loaded (offline mode)';
    });
    els.toggleProxy.addEventListener('click', () => {
      USE_PROXY_ALWAYS = !USE_PROXY_ALWAYS;
      els.toggleProxy.textContent = `Toggle proxy (${USE_PROXY_ALWAYS ? 'on' : 'off'})`;
      refreshData(true);
    });

    // Initial load
    refreshData(true);
  });
  </script>
</body>
</html>
